<!doctype html>
<html lang="lt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prisijungimas • Picly</title>
  <link rel="icon" href="/assets/favicon.png" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="header">
    <div class="container nav">
      <a class="logo" href="/"><img src="/assets/logo.svg" alt="Picly" /><span>Picly.eu</span></a>
      <nav class="nav-links" style="gap:12px">
        <a href="/">Pagrindinis</a>
        <a href="/register.html" class="btn btn--small">Sukurti paskyrą</a>
      </nav>
    </div>
  </header>

  <main class="container" style="max-width:720px;padding:32px 0">
    <div class="card" style="padding:24px">
      <h1 style="margin:0 0 6px">Prisijungti</h1>
      <p class="muted" style="margin:0 0 18px">Įvesk el. paštą ir slaptažodį arba prisijunk kodu el. paštu.</p>

      <!-- Tabs -->
      <div style="display:flex;gap:8px;margin-bottom:16px">
        <button id="tabPwd" class="btn btn--small">Slaptažodžiu</button>
        <button id="tabCode" class="btn btn--small btn--ghost">Kodu el. paštu</button>
      </div>

      <!-- Login by password -->
      <form id="formPwd" class="cta-form" style="max-width:420px">
        <input type="email" name="email" placeholder="El. paštas" autocomplete="username" required />
        <input type="password" name="password" placeholder="Slaptažodis" autocomplete="current-password" required />
        <button class="btn" type="submit">Prisijungti</button>
        <small id="msgPwd" class="muted form-msg" aria-live="polite"></small>
      </form>

      <!-- Login by email code (magic link / 6 sk. kodas) -->
      <form id="formCode" class="cta-form" style="max-width:420px;display:none">
        <input type="email" name="email" placeholder="El. paštas" autocomplete="email" required />
        <button class="btn" type="submit">Gauti prisijungimo kodą</button>
        <small class="muted">Išsiųsime 6 skaitmenų kodą ir „magic link“. Kodas galioja 10 minučių.</small>
        <small id="msgCode" class="muted form-msg" aria-live="polite"></small>
      </form>

      <div style="margin-top:16px">
        <span class="muted">Neturi paskyros?</span>
        <a href="/register.html">Sukurti paskyrą</a>
      </div>
    </div>
  </main>

  <script>
    // Tab switching
    const tabPwd  = document.getElementById('tabPwd');
    const tabCode = document.getElementById('tabCode');
    const formPwd = document.getElementById('formPwd');
    const formCode= document.getElementById('formCode');
    function setTab(which){
      const pwd = which === 'pwd';
      formPwd.style.display  = pwd ? 'flex' : 'none';
      formCode.style.display = pwd ? 'none' : 'flex';
      tabPwd.classList.toggle('btn--ghost', !pwd);
      tabCode.classList.toggle('btn--ghost', pwd);
    }
    tabPwd.addEventListener('click', ()=>setTab('pwd'));
    tabCode.addEventListener('click',()=>setTab('code'));
    setTab('pwd');

    // Login with password
    const msgPwd = document.getElementById('msgPwd');
    formPwd.addEventListener('submit', async (e)=>{
      e.preventDefault();
      msgPwd.textContent = 'Jungiame...';
      const email = formPwd.email.value.trim();
      const password = formPwd.password.value;
      try{
        const res = await fetch('/api/auth/login', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ email, password })
        });
        const data = await res.json().catch(()=>({}));
        if(!res.ok || !data.ok){ msgPwd.textContent = data.error || 'Neteisingi duomenys'; return; }
        // Sėkmė -> į paskyrą
        location.href = '/account';
      }catch(err){
        msgPwd.textContent = 'Tinklo klaida.';
      }
    });

    // Login by email code (send code)
    const msgCode = document.getElementById('msgCode');
    formCode.addEventListener('submit', async (e)=>{
      e.preventDefault();
      msgCode.textContent = 'Siunčiame kodą...';
      const email = formCode.email.value.trim();
      try{
        const res = await fetch('/api/auth/request', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ email })
        });
        const data = await res.json().catch(()=>({}));
        if(!res.ok || !data.ok){ msgCode.textContent = data.error || 'Nepavyko išsiųsti kodo'; return; }
        msgCode.textContent = 'Išsiųsta! Patikrink el. paštą — paspausk „Prisijungti“ nuorodą arba suvesk kodą.';
      }catch(err){
        msgCode.textContent = 'Tinklo klaida.';
      }
    });
  </script>
</body>
</html>
